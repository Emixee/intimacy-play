rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FONCTIONS UTILITAIRES
    // ============================================================
    
    // Vérifie que l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifie que l'utilisateur accède à ses propres données
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Vérifie qu'une valeur est un genre valide
    function isValidGender(gender) {
      return gender in ['homme', 'femme'];
    }
    
    // Vérifie qu'une valeur est un niveau d'intensité valide (1-4)
    function isValidIntensity(level) {
      return level is int && level >= 1 && level <= 4;
    }
    
    // Vérifie qu'une valeur est un statut de session valide
    function isValidSessionStatus(status) {
      return status in ['waiting', 'active', 'completed', 'abandoned'];
    }
    
    // Vérifie qu'une valeur est un rôle de joueur valide
    function isValidPlayerRole(role) {
      return role in ['creator', 'partner'];
    }
    
    // ============================================================
    // COLLECTION: users
    // ============================================================
    
    match /users/{userId} {
      
      // Seul le propriétaire peut lire son profil
      allow read: if isOwner(userId);
      
      // L'utilisateur crée son propre document après inscription
      allow create: if isOwner(userId) &&
        request.resource.data.keys().hasAll([
          'email', 
          'displayName', 
          'gender', 
          'dateOfBirth',
          'premium',
          'premiumUntil',
          'premiumPlan',
          'createdAt',
          'lastLogin',
          'notificationsEnabled',
          'fcmToken'
        ]) &&
        isValidGender(request.resource.data.gender) &&
        request.resource.data.premium == false &&
        request.resource.data.premiumUntil == null &&
        request.resource.data.premiumPlan == null &&
        request.resource.data.email == request.auth.token.email;
      
      // Seul le propriétaire peut modifier son profil
      allow update: if isOwner(userId) &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt &&
        (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['gender']) ||
          isValidGender(request.resource.data.gender)
        );
      
      // Seul le propriétaire peut supprimer son profil
      allow delete: if isOwner(userId);
    }
    
    // ============================================================
    // COLLECTION: sessions
    // ============================================================
    
    match /sessions/{sessionCode} {
      
      // ----------------------------------------------------------
      // LECTURE
      // ----------------------------------------------------------
      // Tout utilisateur authentifié peut lire une session
      // (la sécurité repose sur le code secret de 6 caractères = 1 milliard de combinaisons)
      allow read: if isAuthenticated();
      
      // ----------------------------------------------------------
      // CRÉATION
      // ----------------------------------------------------------
      // Tout utilisateur authentifié peut créer une session
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll([
          'creatorId',
          'creatorGender',
          'partnerId',
          'partnerGender',
          'status',
          'challengeCount',
          'startIntensity',
          'currentChallengeIndex',
          'currentPlayer',
          'challenges',
          'createdAt',
          'startedAt',
          'completedAt'
        ]) &&
        request.resource.data.creatorId == request.auth.uid &&
        isValidGender(request.resource.data.creatorGender) &&
        request.resource.data.partnerId == null &&
        request.resource.data.partnerGender == null &&
        request.resource.data.status == 'waiting' &&
        request.resource.data.challengeCount >= 5 &&
        request.resource.data.challengeCount <= 50 &&
        isValidIntensity(request.resource.data.startIntensity) &&
        request.resource.data.currentChallengeIndex == 0 &&
        request.resource.data.currentPlayer == 'creator' &&
        request.resource.data.challenges is list &&
        request.resource.data.startedAt == null &&
        request.resource.data.completedAt == null;
      
      // ----------------------------------------------------------
      // MISE À JOUR
      // ----------------------------------------------------------
      // Mise à jour autorisée si membre existant ou nouveau partenaire
      allow update: if isAuthenticated() &&
        (
          // Le créateur peut modifier
          (resource.data.creatorId == request.auth.uid) ||
          // Le partenaire existant peut modifier
          (resource.data.partnerId == request.auth.uid) ||
          // Un nouveau partenaire peut rejoindre une session en attente
          (
            resource.data.status == 'waiting' &&
            resource.data.partnerId == null &&
            request.resource.data.partnerId == request.auth.uid
          )
        ) &&
        // Le créateur ne peut pas être changé
        request.resource.data.creatorId == resource.data.creatorId &&
        // Le genre du créateur ne peut pas être changé
        request.resource.data.creatorGender == resource.data.creatorGender &&
        // La date de création ne peut pas être modifiée
        request.resource.data.createdAt == resource.data.createdAt &&
        // Validation des mises à jour de statut
        (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']) ||
          isValidSessionStatus(request.resource.data.status)
        ) &&
        // Validation si un partenaire rejoint
        (
          // Soit le partenaire ne change pas
          request.resource.data.partnerId == resource.data.partnerId ||
          // Soit on ajoute un partenaire à une session en attente
          (
            resource.data.status == 'waiting' &&
            resource.data.partnerId == null &&
            request.resource.data.partnerId == request.auth.uid &&
            isValidGender(request.resource.data.partnerGender)
          )
        ) &&
        // L'index de défi doit rester cohérent
        request.resource.data.currentChallengeIndex >= 0 &&
        request.resource.data.currentChallengeIndex <= request.resource.data.challengeCount &&
        // Le joueur actuel doit être valide
        isValidPlayerRole(request.resource.data.currentPlayer);
      
      // ----------------------------------------------------------
      // SUPPRESSION
      // ----------------------------------------------------------
      // Seul le créateur peut supprimer la session
      allow delete: if isAuthenticated() && 
        resource.data.creatorId == request.auth.uid;
    }
    
    // ============================================================
    // COLLECTION: challenges (templates - optionnel)
    // ============================================================
    
    match /challenges/{challengeId} {
      // Lecture seule pour les utilisateurs authentifiés
      allow read: if isAuthenticated();
      
      // Écriture interdite depuis le client
      allow write: if false;
    }
    
    // ============================================================
    // RÈGLE PAR DÉFAUT
    // ============================================================
    // Refuser tout accès non explicitement autorisé
    match /{document=**} {
      allow read, write: if false;
    }
  }
}