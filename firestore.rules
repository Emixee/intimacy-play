rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FONCTIONS UTILITAIRES
    // ============================================================
    
    // Vérifie que l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifie que l'utilisateur accède à ses propres données
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Vérifie que l'utilisateur est le créateur de la session
    function isSessionCreator() {
      return isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // Vérifie que l'utilisateur est le partenaire de la session
    function isSessionPartner() {
      return isAuthenticated() && resource.data.partnerId == request.auth.uid;
    }
    
    // Vérifie que l'utilisateur est membre de la session (créateur OU partenaire)
    function isSessionMember() {
      return isSessionCreator() || isSessionPartner();
    }
    
    // Vérifie qu'une valeur est un genre valide
    function isValidGender(gender) {
      return gender in ['homme', 'femme'];
    }
    
    // Vérifie qu'une valeur est un niveau d'intensité valide (1-4)
    function isValidIntensity(level) {
      return level is int && level >= 1 && level <= 4;
    }
    
    // Vérifie qu'une valeur est un statut de session valide
    function isValidSessionStatus(status) {
      return status in ['waiting', 'active', 'completed', 'abandoned'];
    }
    
    // Vérifie qu'une valeur est un type de défi valide
    function isValidChallengeType(type) {
      return type in ['audio', 'video', 'photo', 'texte'];
    }
    
    // Vérifie qu'une valeur est un rôle de joueur valide
    function isValidPlayerRole(role) {
      return role in ['creator', 'partner'];
    }
    
    // ============================================================
    // COLLECTION: users
    // ============================================================
    
    match /users/{userId} {
      
      // ----------------------------------------------------------
      // LECTURE
      // ----------------------------------------------------------
      // Seul le propriétaire peut lire son profil
      allow read: if isOwner(userId);
      
      // ----------------------------------------------------------
      // CRÉATION
      // ----------------------------------------------------------
      // L'utilisateur crée son propre document après inscription
      allow create: if isOwner(userId) &&
        // Champs obligatoires présents
        request.resource.data.keys().hasAll([
          'email', 
          'displayName', 
          'gender', 
          'dateOfBirth',
          'premium',
          'premiumUntil',
          'premiumPlan',
          'createdAt',
          'lastLogin',
          'notificationsEnabled',
          'fcmToken'
        ]) &&
        // Validation du genre
        isValidGender(request.resource.data.gender) &&
        // L'utilisateur ne peut pas se créer en premium
        request.resource.data.premium == false &&
        request.resource.data.premiumUntil == null &&
        request.resource.data.premiumPlan == null &&
        // Email correspond à l'email d'auth
        request.resource.data.email == request.auth.token.email;
      
      // ----------------------------------------------------------
      // MISE À JOUR
      // ----------------------------------------------------------
      // Seul le propriétaire peut modifier son profil
      // Certains champs sont immuables
      allow update: if isOwner(userId) &&
        // L'email ne peut pas être modifié
        request.resource.data.email == resource.data.email &&
        // La date de création ne peut pas être modifiée
        request.resource.data.createdAt == resource.data.createdAt &&
        // Si le genre est modifié, il doit être valide
        (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['gender']) ||
          isValidGender(request.resource.data.gender)
        );
      
      // ----------------------------------------------------------
      // SUPPRESSION
      // ----------------------------------------------------------
      // Seul le propriétaire peut supprimer son profil
      allow delete: if isOwner(userId);
    }
    
    // ============================================================
    // COLLECTION: sessions
    // ============================================================
    
    match /sessions/{sessionCode} {
      
      // ----------------------------------------------------------
      // LECTURE
      // ----------------------------------------------------------
      // Seuls les membres de la session peuvent la lire
      allow read: if isSessionMember();
      
      // ----------------------------------------------------------
      // CRÉATION
      // ----------------------------------------------------------
      // Tout utilisateur authentifié peut créer une session
      allow create: if isAuthenticated() &&
        // Champs obligatoires présents
        request.resource.data.keys().hasAll([
          'creatorId',
          'creatorGender',
          'partnerId',
          'partnerGender',
          'status',
          'challengeCount',
          'startIntensity',
          'currentChallengeIndex',
          'currentPlayer',
          'challenges',
          'createdAt',
          'startedAt',
          'completedAt'
        ]) &&
        // Le créateur est l'utilisateur actuel
        request.resource.data.creatorId == request.auth.uid &&
        // Genre du créateur valide
        isValidGender(request.resource.data.creatorGender) &&
        // Pas de partenaire à la création
        request.resource.data.partnerId == null &&
        request.resource.data.partnerGender == null &&
        // Statut initial = waiting
        request.resource.data.status == 'waiting' &&
        // Nombre de défis valide (5-50)
        request.resource.data.challengeCount >= 5 &&
        request.resource.data.challengeCount <= 50 &&
        // Intensité de départ valide
        isValidIntensity(request.resource.data.startIntensity) &&
        // Index initial = 0
        request.resource.data.currentChallengeIndex == 0 &&
        // Joueur initial = creator
        request.resource.data.currentPlayer == 'creator' &&
        // Challenges est un tableau
        request.resource.data.challenges is list &&
        // Pas encore démarrée
        request.resource.data.startedAt == null &&
        request.resource.data.completedAt == null;
      
      // ----------------------------------------------------------
      // MISE À JOUR
      // ----------------------------------------------------------
      // Seuls les membres peuvent mettre à jour la session
      allow update: if isSessionMember() &&
        // Le créateur ne peut pas être changé
        request.resource.data.creatorId == resource.data.creatorId &&
        // Le genre du créateur ne peut pas être changé
        request.resource.data.creatorGender == resource.data.creatorGender &&
        // La date de création ne peut pas être modifiée
        request.resource.data.createdAt == resource.data.createdAt &&
        // Validation des mises à jour de statut
        (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']) ||
          isValidSessionStatus(request.resource.data.status)
        ) &&
        // Validation si un partenaire rejoint
        (
          // Soit le partenaire ne change pas
          request.resource.data.partnerId == resource.data.partnerId ||
          // Soit on ajoute un partenaire (session en attente)
          (
            resource.data.status == 'waiting' &&
            resource.data.partnerId == null &&
            request.resource.data.partnerId == request.auth.uid &&
            isValidGender(request.resource.data.partnerGender)
          )
        ) &&
        // L'index de défi doit rester cohérent
        request.resource.data.currentChallengeIndex >= 0 &&
        request.resource.data.currentChallengeIndex <= request.resource.data.challengeCount &&
        // Le joueur actuel doit être valide
        isValidPlayerRole(request.resource.data.currentPlayer);
      
      // ----------------------------------------------------------
      // SUPPRESSION
      // ----------------------------------------------------------
      // Seul le créateur peut supprimer la session
      allow delete: if isSessionCreator();
    }
    
    // ============================================================
    // COLLECTION: challenges (templates - optionnel)
    // ============================================================
    
    match /challenges/{challengeId} {
      // Lecture seule pour les utilisateurs authentifiés
      // (si tu décides de stocker les défis dans Firestore)
      allow read: if isAuthenticated();
      
      // Écriture interdite depuis le client
      // (géré par admin/migration uniquement)
      allow write: if false;
    }
    
    // ============================================================
    // RÈGLE PAR DÉFAUT
    // ============================================================
    // Refuser tout accès non explicitement autorisé
    match /{document=**} {
      allow read, write: if false;
    }
  }
}